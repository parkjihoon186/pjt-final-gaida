<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS-ME</title>
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° í°íŠ¸ ë¡œë“œ -->
    <!-- Tailwind CSS: ìœ í‹¸ë¦¬í‹° ê¸°ë°˜ CSS í”„ë ˆì„ì›Œí¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js: ë°ì´í„° ì‹œê°í™”ë¥¼ ìœ„í•œ ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: 'Black Han Sans', 'Noto Sans KR' í°íŠ¸ ë¡œë“œ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- ë‚´ë¶€ CSS ìŠ¤íƒ€ì¼ ì •ì˜ -->
    <style>
        /* ê¸°ë³¸ ë°”ë”” ìŠ¤íƒ€ì¼: í°íŠ¸, ë°°ê²½ìƒ‰, ê¸€ììƒ‰ ì„¤ì • */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #121212; /* ë‹¤í¬ í…Œë§ˆ ë°°ê²½ìƒ‰ */
            color: #ffffff; /* ê¸°ë³¸ ê¸€ììƒ‰ */
        }
        /* ì¹´ë“œ UI ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: #1e1e1e;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
        }
        /* Black Han Sans í°íŠ¸ ì „ìš© í´ë˜ìŠ¤ */
        .black-han-sans {
            font-family: 'Black Han Sans', sans-serif;
        }
        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        /* ë°˜ì‘í˜•: í™”ë©´ ë„ˆë¹„ê°€ 768px ì´ìƒì¼ ë•Œ ì°¨íŠ¸ ë†’ì´ ì¡°ì • */
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        /* ì£¼ìš” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-primary {
            background-color: #f5c000; /* ì•°ë²„ ìƒ‰ìƒ */
            color: #121212;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #d8a900;
        }
        /* ë³´ì¡° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-secondary {
            background-color: #a0a0a0;
            color: #121212;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #7a7a7a;
        }
        /* ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ ìœ„í•œ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
        .pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        /* ìš´ë™ ì…ë ¥ í¼ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .input-group-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        /* ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤(alert ëŒ€ì²´) ìŠ¤íƒ€ì¼ */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1e1e1e;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            text-align: center;
        }
        .message-box button {
            margin-top: 16px;
        }
        /* ê°œì¸ ìµœê³  ê¸°ë¡ ë‹¬ì„± ì‹œ íŠ¸ë¡œí”¼ ì• ë‹ˆë©”ì´ì…˜ */
        .trophy-container.sparkle .trophy-emoji {
            animation: sparkle-animation 1.5s ease-in-out;
        }
        @keyframes sparkle-animation {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(1.75) drop-shadow(0 0 8px #f5c000); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .trophy-emoji { font-size: 3rem; }
        .volume-color { color: #f5c000; } /* ë³¼ë¥¨ ê°•ì¡° ìƒ‰ìƒ */
        /* ì‚¬ìš©ì ID í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .user-id-display {
            font-size: 0.75rem; color: #555; background-color: #191919;
            padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 1rem;
        }
        /* ì„¸ì…˜ ë¹„êµ ì¹´ë“œ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .comparison-grid {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center;
        }
        .comparison-grid .exercise-name { grid-column: 1 / -1; }
        .arrow-up { color: #28a745; } /* ìƒìŠ¹ í™”ì‚´í‘œ ìƒ‰ìƒ */
        .arrow-down { color: #dc3545; } /* í•˜ë½ í™”ì‚´í‘œ ìƒ‰ìƒ */
        /* í¼ ë ˆì´ë¸” ë° ì…ë ¥ í•„ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .form-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: #a0a0a0;
            margin-bottom: 0.25rem;
            display: block;
        }
        .form-input, .form-select {
             width: 100%;
             padding: 0.75rem;
             background-color: #2a2a2a;
             border: 1px solid #444;
             color: #ffffff;
             border-radius: 0.5rem;
             transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus {
            ring: 2;
            ring-color: #f5c000;
            border-color: transparent;
            outline: none;
        }
        /* ì±—ë´‡ UI ìŠ¤íƒ€ì¼ */
        #chat-messages {
            height: 250px;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #f5c000;
            color: #121212;
            align-self: flex-end; /* ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½ */
        }
        .ai-message {
            background-color: #2a2a2a;
            color: #e0e0e0;
            align-self: flex-start; /* AI ë©”ì‹œì§€ëŠ” ì™¼ìª½ */
        }
        .chat-input-container {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
    </style>
</head>
<body class="text-gray-200">

    <!-- ì „ì²´ í˜ì´ì§€ ì»¨í…Œì´ë„ˆ -->
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- í˜ì´ì§€ í—¤ë” -->
        <header class="text-center py-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-50">
                VS-ME
            </h1>
            <p class="mt-2 text-gray-400 text-lg font-bold">ìŠ¹ë¦¬ëŠ” ë°ì´í„°ì—ì„œ ì‹œì‘ëœë‹¤.</p>
            <div class="user-id-display">
                <span id="user-id-text">ë¡œê·¸ì¸ ì¤‘...</span>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (2ë‹¨ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ) -->
        <main class="grid lg:grid-cols-3 gap-6">

            <!-- ì™¼ìª½ ì»¬ëŸ¼: ì…ë ¥ ë° ë¡œê·¸ ì„¹ì…˜ -->
            <section class="lg:col-span-1 flex flex-col gap-6">
                <!-- ì‚¬ìš©ì ì •ë³´ ì…ë ¥ ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-50">ì‚¬ìš©ì ì •ë³´</h2>
                    <div id="user-profile-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="age" class="form-label">ë‚˜ì´</label>
                                <input type="number" id="age" class="form-input" placeholder="ì„¸">
                            </div>
                            <div>
                                <label for="gender" class="form-label">ì„±ë³„</label>
                                <select id="gender" class="form-select">
                                    <option value="male">ë‚¨ì„±</option>
                                    <option value="female">ì—¬ì„±</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="height" class="form-label">í‚¤</label>
                                <input type="number" id="height" class="form-input" placeholder="cm">
                            </div>
                            <div>
                                <label for="weight" class="form-label">ì²´ì¤‘</label>
                                <input type="number" id="weight" class="form-input" placeholder="kg">
                            </div>
                        </div>
                        <div>
                             <label for="activity-level" class="form-label">í™œë™ ìˆ˜ì¤€</label>
                             <select id="activity-level" class="form-select">
                                 <option value="1.2">ë§¤ìš° ë‚®ìŒ (ì¢Œì‹ ìƒí™œ)</option>
                                 <option value="1.375">ë‚®ìŒ (ì£¼ 1-3íšŒ ìš´ë™)</option>
                                 <option value="1.55" selected>ë³´í†µ (ì£¼ 3-5íšŒ ìš´ë™)</option>
                                 <option value="1.725">ë†’ìŒ (ì£¼ 6-7íšŒ ìš´ë™)</option>
                                 <option value="1.9">ë§¤ìš° ë†’ìŒ (ê³ ê°•ë„ í›ˆë ¨)</option>
                             </select>
                        </div>
                    </div>
                </div>

                <!-- í›ˆë ¨ ê¸°ë¡ ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-50">í›ˆë ¨ ê¸°ë¡</h2>
                    <!-- ìš´ë™ ì…ë ¥ í¼ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì»¨í…Œì´ë„ˆ -->
                    <div id="exercise-form-container" class="space-y-4"></div>
                    <button id="add-exercise-btn" class="w-full btn-secondary font-bold py-3 rounded-lg mt-4 text-sm">+ ì „ìˆ  ì¶”ê°€í•˜ê¸°</button>
                    <button id="record-session-btn" class="w-full btn-primary font-bold py-3 rounded-lg mt-2 text-lg">í›ˆë ¨ê¸°ë¡í•´!</button>
                </div>
                
                <!-- ì˜ì–‘ ê¸°ë¡ ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-50">ì˜ì–‘ ê¸°ë¡</h2>
                     <div class="space-y-4">
                        <!-- ì£¼ìš” ì˜ì–‘ì†Œ ì…ë ¥ -->
                        <div class="grid grid-cols-3 gap-4">
                             <div><label class="form-label">íƒ„ìˆ˜í™”ë¬¼(g)</label><input type="number" id="carbs-input" class="form-input"></div>
                            <div><label class="form-label">ë‹¨ë°±ì§ˆ(g)</label><input type="number" id="protein-input" class="form-input"></div>
                            <div><label class="form-label">ì§€ë°©(g)</label><input type="number" id="fat-input" class="form-input"></div>
                        </div>
                         <!-- ë³´ì¶©ì œ ì…ë ¥ -->
                         <h3 class="text-lg font-bold text-gray-300 pt-2">í•µì‹¬ ë³´ì¶©ì œ</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div><label class="form-label">BCAA(g)</label><input type="number" id="bcaa-input" class="form-input"></div>
                            <div><label class="form-label">í¬ë ˆì•„í‹´(g)</label><input type="number" id="creatine-input" class="form-input"></div>
                            <div><label class="form-label">ê¸€ë£¨íƒ€ë¯¼(g)</label><input type="number" id="glutamine-input" class="form-input"></div>
                        </div>
                     </div>
                    <button id="record-nutrition-btn" class="w-full btn-secondary font-bold py-3 rounded-lg mt-4 text-lg">ì˜ì–‘ ê¸°ë¡í•´!</button>
                </div>
                
                <!-- ì‘ì „ ë¡œê·¸(í›ˆë ¨ ê¸°ë¡ ëª©ë¡) ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-50">ì‘ì „ ë¡œê·¸</h2>
                    <div id="session-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <p id="empty-session-message" class="text-center text-gray-500 py-4">ìš´ë™ ì„¸ì…˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- ì˜ì–‘ ë¡œê·¸(ì˜ì–‘ ê¸°ë¡ ëª©ë¡) ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-50">ì˜ì–‘ ë¡œê·¸</h2>
                    <div id="nutrition-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <p id="empty-nutrition-message" class="text-center text-gray-500 py-4">ì˜ì–‘ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
                 <!-- AI ìš´ë™ ì½”ì¹˜ ì±—ë´‡ ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-50">AI ìš´ë™ ì½”ì¹˜</h2>
                    <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ í‘œì‹œë  ì˜ì—­ -->
                    <div id="chat-messages" class="bg-gray-900 rounded-lg">
                        <div class="chat-message ai-message">ì•ˆë…•í•˜ì„¸ìš”! ë‹¹ì‹ ì˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì˜ì–‘ ì§ˆë¬¸ì— ë‹µë³€í•´ ë“œë¦½ë‹ˆë‹¤.</div>
                    </div>
                    <!-- ë©”ì‹œì§€ ì…ë ¥ ë° ì „ì†¡ ì˜ì—­ -->
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" class="form-input flex-grow" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                        <button id="chat-send-btn" class="btn-primary font-bold px-4 rounded-lg">ì „ì†¡</button>
                    </div>
                </div>
            </section>

            <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ë°ì´í„° ì‹œê°í™” ë° ë¶„ì„ ì„¹ì…˜ -->
            <section class="lg:col-span-2 flex flex-col gap-6">
                <!-- ì—­ëŒ€ ìµœê³  ê¸°ë¡ ì¹´ë“œ -->
                <div class="card p-6 text-center">
                    <h2 class="text-2xl font-bold text-gray-50">ì—­ëŒ€ ìµœê³  ê¸°ë¡ (ì´ ë³¼ë¥¨)</h2>
                    <div id="trophy-container" class="mt-4 flex flex-col items-center trophy-container">
                        <div class="trophy-emoji">ğŸ†</div>
                        <p id="personal-best-volume" class="text-3xl font-extrabold volume-color mt-2">0kg</p>
                    </div>
                </div>
                
                <!-- ì£¼ê°„ ì„±ì·¨ë„ ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-50 mb-4">ì£¼ê°„ ì„±ì·¨ë„</h2>
                    <p class="text-gray-400 mb-4">ì´ë²ˆ ì£¼ ë‹¹ì‹ ì˜ ë°œìì·¨ì…ë‹ˆë‹¤. ê¾¸ì¤€í•¨ì´ ìŠ¹ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.</p>
                    <!-- ìš´ë™í•œ ë‚ ì„ í‘œì‹œí•  ìŠ¤íƒ¬í”„ ì˜ì—­ -->
                    <div id="achievement-stamps" class="grid grid-cols-7 gap-2 text-center">
                    </div>
                </div>

                <!-- ìµœì‹  ì„¸ì…˜ê³¼ ì´ì „ ì„¸ì…˜ ë¹„êµ ì¹´ë“œ -->
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-50 mb-4">ì „ëµ ë¶„ì„: ê³¼ê±°ì˜ ë‚˜ VS í˜„ì¬ì˜ ë‚˜</h2>
                    <div id="comparison-card" class="space-y-4">
                       <p class="text-center text-gray-500">ë¹„êµí•  ì„¸ì…˜ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- ì„±ì¥ ê·¸ë˜í”„(ì°¨íŠ¸) ì¹´ë“œ -->
                <div class="card p-6">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-50">ìŠ¹ë¦¬ì˜ ì—°ëŒ€ê¸°</h2>
                        <!-- ì°¨íŠ¸ì— í‘œì‹œí•  ìš´ë™ í•„í„°ë§ ë“œë¡­ë‹¤ìš´ -->
                        <select id="exercise-filter" class="form-select w-auto">
                            <option value="total">ì´ ë³¼ë¥¨</option>
                        </select>
                    </div>
                    <p class="text-gray-400 mb-4">ì´ ì°¨íŠ¸ëŠ” ë‹¹ì‹ ì˜ **'ì´ ì„¸ì…˜ ë³¼ë¥¨'** ë˜ëŠ” **ê°œë³„ ìš´ë™ ë³¼ë¥¨**ì˜ ë³€í™”ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ìš°ìƒí–¥ ê·¸ë˜í”„ëŠ” ë‹¹ì‹ ì˜ ì„±ì¥ì„ ì¦ëª…í•©ë‹ˆë‹¤.</p>
                    <div class="chart-container">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>

                <!-- AI í›ˆë ¨ ë¶„ì„ ì¹´ë“œ -->
                <div class="card p-6">
                     <h2 class="text-2xl font-bold mb-4 text-gray-50">AIì½”ì¹˜ í”¼ë“œë°±</h2>
                     <p class="text-gray-400 mb-4">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¹ì‹ ì˜ í›ˆë ¨ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³ , ìŠ¤íŠ¸ë­ìŠ¤ì™€ íšŒë³µì— ëŒ€í•œ ì „ëµì  ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤.</p>
                    <button id="analyze-btn" class="w-full btn-primary font-bold py-3 rounded-lg text-lg">í›ˆë ¨ ë¶„ì„!</button>
                    <!-- ë¶„ì„ ê²°ê³¼ í”¼ë“œë°± í‘œì‹œ ì˜ì—­ -->
                    <div id="feedback-container" class="mt-4">
                        <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
                        <div id="loading-indicator" class="hidden text-center p-4">
                            <div class="pulse w-8 h-8 rounded-full bg-yellow-500 mx-auto"></div>
                            <p class="mt-2 text-gray-400">ì „íˆ¬ ê¸°ë¡ ë¶„ì„ ì¤‘...</p>
                        </div>
                        <!-- ë¶„ì„ ê²°ê³¼ ë©”ì‹œì§€ ë°•ìŠ¤ -->
                        <div id="feedback-box" class="bg-gray-800 border border-gray-700 rounded-lg p-6 min-h-[150px] flex items-center justify-center">
                            <p id="feedback-message" class="text-center text-gray-500">ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¹ì‹ ì˜ ìŠ¹íŒ¨ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
                
                <!-- AI ì‹ë‹¨ ë¶„ì„ ì¹´ë“œ -->
                <div class="card p-6">
                     <h2 class="text-2xl font-bold mb-4 text-gray-50">AI ì „ëµ ë¸Œë¦¬í•‘</h2>
                     <p class="text-gray-400 mb-4">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¹ì‹ ì˜ ì‹ë‹¨ê³¼ ìš´ë™ ë‚´ì—­ì„ ë¶„ì„í•˜ê³ , ì‹ ì²´ ì •ë³´ì— ê¸°ë°˜í•œ ê°œì¸ ë§ì¶¤í˜• í”¼ë“œë°±ì„ ë°›ìœ¼ì„¸ìš”.</p>
                    <button id="analyze-diet-btn" class="w-full btn-primary font-bold py-3 rounded-lg text-lg">ì‹ë‹¨ ë¶„ì„!</button>
                    <!-- ì‹ë‹¨ ë¶„ì„ ê²°ê³¼ í”¼ë“œë°± í‘œì‹œ ì˜ì—­ -->
                    <div id="diet-feedback-container" class="mt-4">
                        <div id="diet-loading-indicator" class="hidden text-center p-4">
                            <div class="pulse w-8 h-8 rounded-full bg-yellow-500 mx-auto"></div>
                            <p class="mt-2 text-gray-400">ì‹ë‹¨ ê¸°ë¡ ë¶„ì„ ì¤‘...</p>
                        </div>
                        <div id="diet-feedback-box" class="bg-gray-800 border border-gray-700 rounded-lg p-6 min-h-[150px] flex items-center justify-center">
                            <p id="diet-feedback-message" class="text-center text-gray-500">ì‚¬ìš©ì ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì‹ë‹¨ì„ ê¸°ë¡í•œ í›„, ë¶„ì„ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ (ëª¨ë‹¬) -->
    <div id="message-box" class="message-box">
        <p id="message-text" class="text-center text-gray-50"></p>
        <button id="message-ok-btn" class="btn-primary px-4 py-2 rounded">í™•ì¸</button>
    </div>

    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ ì‹œì‘ -->
    <script type="module">
        
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        let userId, progressChart;
        let allSessions = []; // ëª¨ë“  ìš´ë™ ì„¸ì…˜ ë°ì´í„° ì €ì¥
        let allNutrition = []; // ëª¨ë“  ì˜ì–‘ ë°ì´í„° ì €ì¥

        // UI ìš”ì†Œë“¤ì„ ê°ì²´ë¡œ ê´€ë¦¬í•˜ì—¬ ì ‘ê·¼ ìš©ì´ì„± í™•ë³´
        const ui = {
            // ì‚¬ìš©ì í”„ë¡œí•„
            userProfileForm: document.getElementById('user-profile-form'),
            age: document.getElementById('age'),
            gender: document.getElementById('gender'),
            height: document.getElementById('height'),
            weight: document.getElementById('weight'),
            activityLevel: document.getElementById('activity-level'),
            // ì„¸ì…˜ ê¸°ë¡
            formContainer: document.getElementById('exercise-form-container'),
            addBtn: document.getElementById('add-exercise-btn'),
            recordBtn: document.getElementById('record-session-btn'),
            list: document.getElementById('session-list'),
            emptySessionMsg: document.getElementById('empty-session-message'),
            // ì˜ì–‘ ê¸°ë¡
            proteinInput: document.getElementById('protein-input'),
            carbsInput: document.getElementById('carbs-input'),
            fatInput: document.getElementById('fat-input'),
            bcaaInput: document.getElementById('bcaa-input'),
            creatineInput: document.getElementById('creatine-input'),
            glutamineInput: document.getElementById('glutamine-input'),
            recordNutritionBtn: document.getElementById('record-nutrition-btn'),
            nutritionList: document.getElementById('nutrition-list'),
            emptyNutritionMsg: document.getElementById('empty-nutrition-message'),
            // ë¶„ì„
            analyzeBtn: document.getElementById('analyze-btn'),
            loading: document.getElementById('loading-indicator'),
            feedbackBox: document.getElementById('feedback-box'),
            feedbackMsg: document.getElementById('feedback-message'),
            analyzeDietBtn: document.getElementById('analyze-diet-btn'),
            dietLoading: document.getElementById('diet-loading-indicator'),
            dietFeedbackBox: document.getElementById('diet-feedback-box'),
            dietFeedbackMsg: document.getElementById('diet-feedback-message'),
            // ì°¨íŠ¸ ë° ë¹„êµ
            chartCanvas: document.getElementById('progress-chart'),
            comparisonCard: document.getElementById('comparison-card'),
            personalBestVolume: document.getElementById('personal-best-volume'),
            trophyContainer: document.getElementById('trophy-container'),
            exerciseFilter: document.getElementById('exercise-filter'),
            achievementStamps: document.getElementById('achievement-stamps'),
            // ì±—ë´‡
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            // ì¼ë°˜
            userIdText: document.getElementById('user-id-text'),
            messageBox: document.getElementById('message-box'),
            messageText: document.getElementById('message-text'),
            messageOkBtn: document.getElementById('message-ok-btn'),
        };
        
        // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showMessage(message) {
            ui.messageText.innerText = message;
            ui.messageBox.style.display = 'block';
        }

        // ë©”ì‹œì§€ ë°•ìŠ¤ì˜ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ë°•ìŠ¤ ìˆ¨ê¹€
        ui.messageOkBtn.addEventListener('click', () => { ui.messageBox.style.display = 'none'; });

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
        async function init() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒˆë¡œ ìƒì„±
            userId = localStorage.getItem('supabaseUserId');
            if (!userId) {
                userId = crypto.randomUUID(); // ìƒˆë¡œìš´ ê³ ìœ  ID ìƒì„±
                localStorage.setItem('supabaseUserId', userId);
            }
            ui.userIdText.textContent = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}...`;
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° UI ì„¤ì •
            loadUserProfile();
            initChart();
            
            // ë°ì´í„° ë¡œë”©ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
            await Promise.all([
                fetchSessions(),
                fetchNutrition()
            ]);

            // ë°ì´í„° ë¡œë“œ í›„ UI ì—…ë°ì´íŠ¸
            updateAllUI();
        }
        
        // ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        function saveUserProfile() {
            const profile = {
                age: ui.age.value,
                gender: ui.gender.value,
                height: ui.height.value,
                weight: ui.weight.value,
                activityLevel: ui.activityLevel.value
            };
            localStorage.setItem('userProfile', JSON.stringify(profile));
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ UIì— ì ìš©
        function loadUserProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile'));
            if (profile) {
                ui.age.value = profile.age || '';
                ui.gender.value = profile.gender || 'male';
                ui.height.value = profile.height || '';
                ui.weight.value = profile.weight || '';
                ui.activityLevel.value = profile.activityLevel || '1.55';
            }
        }

        // 'ì „ìˆ  ì¶”ê°€í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ìš´ë™ ì…ë ¥ í¼ ë™ì  ìƒì„±
        function addExerciseInput() {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'exercise-input-group flex flex-col space-y-2 p-3 border border-gray-700 rounded-lg';
            inputGroup.innerHTML = `
                <input type="text" placeholder="ìš´ë™ëª…" class="form-input">
                <div class="input-group-grid">
                    <input type="number" placeholder="ë¬´ê²Œ(kg)" class="form-input">
                    <input type="number" placeholder="íšŸìˆ˜" class="form-input">
                    <input type="number" placeholder="ì„¸íŠ¸" class="form-input">
                    <input type="number" placeholder="íœ´ì‹(ì´ˆ)" class="form-input">
                </div>
            `;
            ui.formContainer.appendChild(inputGroup);
        }

        // 'í›ˆë ¨ê¸°ë¡í•´!' ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ëœ ì„¸ì…˜ ì •ë³´ë¥¼ Firestoreì— ì €ì¥
        async function recordSession() {
            const inputGroups = document.querySelectorAll('.exercise-input-group');
            let exercises = [];
            let valid = true;

            // ëª¨ë“  ì…ë ¥ í¼ì—ì„œ ë°ì´í„° ì¶”ì¶œ ë° ìœ íš¨ì„± ê²€ì‚¬
            inputGroups.forEach(group => {
                const name = group.querySelector('input[type="text"]').value.trim();
                const inputs = group.querySelectorAll('input[type="number"]');
                const weight = parseFloat(inputs[0].value);
                const reps = parseInt(inputs[1].value);
                const sets = parseInt(inputs[2].value);
                const rest = parseInt(inputs[3].value);

                if (name && [weight, reps, sets, rest].every(val => !isNaN(val) && val >= 0)) {
                    exercises.push({ name, weight, reps, sets, rest });
                } else if ([name, weight, reps, sets, rest].some(val => val)) { valid = false; }
            });

            if (!valid || exercises.length === 0) {
                showMessage("ì ì–´ë„ í•˜ë‚˜ì˜ ìœ íš¨í•œ ìš´ë™ ê¸°ë¡(ëª¨ë“  í•„ë“œ í¬í•¨)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
            }
            
            // ê°œì¸ ìµœê³  ê¸°ë¡ ê°±ì‹  í™•ì¸ ë° ì¶•í•˜ ë©”ì‹œì§€
            const oldPersonalBest = Math.max(...allSessions.map(s => s.total_volume), 0);
            const totalSessionVolume = exercises.reduce((sum, ex) => sum + (ex.weight * ex.reps * ex.sets), 0);

            if (totalSessionVolume > oldPersonalBest && oldPersonalBest > 0) {
                showMessage("ğŸ‰ ê°œì¸ ìµœê³  ê¸°ë¡ ë‹¬ì„±! ğŸ‰\nìƒˆë¡œìš´ ì „íˆ¬ë ¥ì„ ì¦ëª…í–ˆìŠµë‹ˆë‹¤!");
                ui.trophyContainer.classList.add('sparkle');
                setTimeout(() => ui.trophyContainer.classList.remove('sparkle'), 1500);
            }
            
            // Supabaseì— ë°ì´í„° ì €ì¥
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({ total_volume: totalSessionVolume, exercises })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }

                ui.formContainer.innerHTML = ''; addExerciseInput(); // í¼ ì´ˆê¸°í™”
                await fetchSessions(); // ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                updateAllUI(); // UI ì—…ë°ì´íŠ¸
            } catch (e) { console.error("ì„¸ì…˜ ê¸°ë¡ ì‹¤íŒ¨: ", e); showMessage("ì„¸ì…˜ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
        }
        
        // 'ì˜ì–‘ ê¸°ë¡í•´!' ë²„íŠ¼ í´ë¦­ ì‹œ ì˜ì–‘ ì •ë³´ë¥¼ Firestoreì— ì €ì¥
        async function recordNutrition() {
            const nutritionData = {
                carbs: parseFloat(ui.carbsInput.value) || 0,
                protein: parseFloat(ui.proteinInput.value) || 0,
                fat: parseFloat(ui.fatInput.value) || 0,
                bcaa: parseFloat(ui.bcaaInput.value) || 0,
                creatine: parseFloat(ui.creatineInput.value) || 0,
                glutamine: parseFloat(ui.glutamineInput.value) || 0,
            };

            if (nutritionData.protein <= 0 && nutritionData.carbs <= 0 && nutritionData.fat <= 0) {
                showMessage("ì£¼ìš” ì˜ì–‘ì†Œ(íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°©) ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
            }

            try {
                const response = await fetch('/api/nutrition', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(nutritionData)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
                
                [ui.carbsInput, ui.proteinInput, ui.fatInput, ui.bcaaInput, ui.creatineInput, ui.glutamineInput].forEach(i => i.value = ''); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                showMessage("ì˜ì–‘ ê¸°ë¡ ì™„ë£Œ!");
                await fetchNutrition(); // ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                updateAllUI(); // UI ì—…ë°ì´íŠ¸
            } catch (e) { console.error("ì˜ì–‘ ê¸°ë¡ ì‹¤íŒ¨:", e); showMessage("ì˜ì–‘ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
        }

        // Supabaseì—ì„œ ì„¸ì…˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchSessions() {
            if (!userId) return;
            try {
                const response = await fetch('/api/sessions', { headers: { 'X-User-ID': userId } });
                if (!response.ok) throw new Error('ì„œë²„ì—ì„œ ì„¸ì…˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                allSessions = await response.json();
            } catch (error) {
                console.error("ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                allSessions = [];
            }
        }
        
        // Supabaseì—ì„œ ì˜ì–‘ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchNutrition() {
            if (!userId) return;
            try {
                const response = await fetch('/api/nutrition', { headers: { 'X-User-ID': userId } });
                if (!response.ok) throw new Error('ì„œë²„ì—ì„œ ì˜ì–‘ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                allNutrition = await response.json();
            } catch (error) {
                console.error("ì˜ì–‘ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                allNutrition = [];
            }
        }

        // ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ê´€ë ¨ëœ ëª¨ë“  UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateAllUI() {
            // ì„¸ì…˜ ê´€ë ¨ UI ì—…ë°ì´íŠ¸
            renderSessionList(allSessions);
            updateChart(ui.exerciseFilter.value);
            updateComparisonCard();
            updatePersonalBest();
            updateExerciseFilter();
            updateWeeklyAchievement();
            // ì˜ì–‘ ê´€ë ¨ UI ì—…ë°ì´íŠ¸
            renderNutritionList(allNutrition);
        }

        // ì„¸ì…˜ ëª©ë¡ì„ UIì— ë Œë”ë§
        function renderSessionList(sessions) {
            ui.list.innerHTML = '';
            if (sessions.length === 0) { ui.list.appendChild(ui.emptySessionMsg); ui.emptySessionMsg.style.display = 'block'; return; }
            
            ui.emptySessionMsg.style.display = 'none';
            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'flex flex-col bg-gray-900 p-3 rounded-lg border border-gray-700';
                const date = session.created_at ? new Date(session.created_at).toLocaleDateString() : 'ë‚ ì§œ ë¯¸ìƒ';
                let exercisesHtml = session.exercises.map(ex => `<p class="text-xs text-gray-500">- ${ex.name}: ${ex.weight}kg x ${ex.reps}íšŒ x ${ex.sets}ì„¸íŠ¸</p>`).join('');
                item.innerHTML = `
                    <div class="flex justify-between items-center font-bold text-gray-200"> <p>${date}</p> <p class="text-sm volume-color">${session.total_volume.toLocaleString()}kg</p> </div>
                    <div class="mt-2 text-sm text-gray-300">${exercisesHtml}</div>`;
                ui.list.appendChild(item);
            });
        }
        
        // ì˜ì–‘ ëª©ë¡ì„ UIì— ë Œë”ë§
        function renderNutritionList(nutrition) {
            ui.nutritionList.innerHTML = '';
            if (nutrition.length === 0) { ui.nutritionList.appendChild(ui.emptyNutritionMsg); ui.emptyNutritionMsg.style.display = 'block'; return; }

            ui.emptyNutritionMsg.style.display = 'none';
            nutrition.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'bg-gray-900 p-3 rounded-lg border border-gray-700';
                const date = entry.created_at ? new Date(entry.created_at).toLocaleDateString() : 'ë‚ ì§œ ë¯¸ìƒ';
                item.innerHTML = `
                    <p class="font-bold text-gray-200 mb-2">${date}</p>
                    <div class="text-xs grid grid-cols-3 gap-1 text-gray-400">
                        <span>íƒ„: ${entry.carbs || 0}g</span>
                        <span>ë‹¨: ${entry.protein || 0}g</span>
                        <span>ì§€: ${entry.fat || 0}g</span>
                        <span>BCAA: ${entry.bcaa || 0}g</span>
                        <span>í¬ë ˆì•„í‹´: ${entry.creatine || 0}g</span>
                        <span>ê¸€ë£¨íƒ€ë¯¼: ${entry.glutamine || 0}g</span>
                    </div>`;
                ui.nutritionList.appendChild(item);
            });
        }
        
        // ì£¼ê°„ ìš´ë™ ì„±ì·¨ë„ë¥¼ ìŠ¤íƒ¬í”„ í˜•íƒœë¡œ UIì— í‘œì‹œ
        function updateWeeklyAchievement() {
            const stampsContainer = ui.achievementStamps;
            stampsContainer.innerHTML = '';

            const today = new Date();
            const dayOfWeek = today.getDay();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            startOfWeek.setHours(0, 0, 0, 0);

            const weekDays = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            const workedOutDays = new Set();

            for (const session of allSessions) {
                if (session.created_at) {
                    const sessionDate = new Date(session.created_at);
                    if (sessionDate >= startOfWeek) {
                        let sessionDay = sessionDate.getDay();
                        sessionDay = (sessionDay === 0) ? 6 : sessionDay - 1;
                        workedOutDays.add(sessionDay);
                    }
                }
            }

            for (let i = 0; i < 7; i++) {
                const dayDiv = document.createElement('div');
                const dayLabel = document.createElement('p');
                dayLabel.className = 'text-sm text-gray-500';
                dayLabel.textContent = weekDays[i];

                const stampCircle = document.createElement('div');
                stampCircle.className = 'w-10 h-10 mx-auto mt-1 rounded-full flex items-center justify-center text-2xl bg-gray-700 transition-colors';

                if (workedOutDays.has(i)) {
                    stampCircle.innerHTML = 'ğŸ¾';
                    stampCircle.classList.remove('bg-gray-700');
                    stampCircle.classList.add('bg-amber-500');
                }

                dayDiv.appendChild(dayLabel);
                dayDiv.appendChild(stampCircle);
                stampsContainer.appendChild(dayDiv);
            }
        }

        // Chart.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            const ctx = ui.chartCanvas.getContext('2d');
            progressChart = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: [{ label: 'ë³¼ë¥¨(kg)', data: [], borderColor: '#f5c000', backgroundColor: 'rgba(245, 192, 0, 0.1)', fill: true, tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#a0a0a0' }, grid: { color: '#333' } }, x: { ticks: { color: '#a0a0a0' }, grid: { color: '#333' } } }, plugins: { legend: { display: false } } }
            });
        }
        
        // ê¸°ë¡ëœ ìš´ë™ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ì°¨íŠ¸ í•„í„° ì˜µì…˜ ë™ì  ì—…ë°ì´íŠ¸
        function updateExerciseFilter() {
            const exerciseNames = new Set(allSessions.flatMap(s => s.exercises.map(e => e.name)));
            const currentOptions = new Set([...ui.exerciseFilter.options].map(o => o.value));
            exerciseNames.forEach(name => {
                if (!currentOptions.has(name)) {
                    const option = document.createElement('option');
                    option.value = name; option.textContent = name;
                    ui.exerciseFilter.appendChild(option);
                }
            });
        }

        // í•„í„° ê°’ì— ë”°ë¼ ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        function updateChart(filter = 'total') {
            if (!progressChart) return;
            const sortedSessions = [...allSessions].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            let chartData;
            if (filter === 'total') {
                chartData = sortedSessions.map(d => d.total_volume);
            } else {
                chartData = sortedSessions.map(session => session.exercises.filter(ex => ex.name === filter).reduce((sum, ex) => sum + (ex.weight * ex.reps * ex.sets), 0));
            }
            progressChart.data.labels = sortedSessions.map(d => d.created_at ? new Date(d.created_at).toLocaleDateString() : 'ë¯¸ìƒ');
            progressChart.data.datasets[0].data = chartData;
            progressChart.update();
        }

        // ìµœì‹  ë‘ ì„¸ì…˜ì„ ë¹„êµí•˜ì—¬ UIì— í‘œì‹œ
        function updateComparisonCard() {
            const sortedSessions = [...allSessions].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            if (sortedSessions.length < 2) {
                ui.comparisonCard.innerHTML = `<p class="text-center text-gray-500">ë¹„êµí•  ì„¸ì…˜ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>`; return;
            }
            const latest = sortedSessions[0];
            const previous = sortedSessions[1];
            const allExerciseNames = new Set([...latest.exercises.map(e => e.name), ...previous.exercises.map(e => e.name)]);
            let comparisonHtml = `<div class="grid grid-cols-2 gap-4 text-center mb-4">
                <div><p class="font-bold">${new Date(latest.created_at).toLocaleDateString()} (ìµœì‹ )</p><p class="text-sm volume-color">${latest.total_volume.toLocaleString()}kg</p></div>
                <div><p class="font-bold">${new Date(previous.created_at).toLocaleDateString()} (ì´ì „)</p><p class="text-sm text-gray-400">${previous.total_volume.toLocaleString()}kg</p></div>
            </div>`;

            allExerciseNames.forEach(name => {
                const latestEx = latest.exercises.find(e => e.name === name);
                const prevEx = previous.exercises.find(e => e.name === name);
                const latestVol = latestEx ? latestEx.weight * latestEx.reps * latestEx.sets : 0;
                const prevVol = prevEx ? prevEx.weight * prevEx.reps * prevEx.sets : 0;
                let arrow = (latestVol > prevVol) ? `<span class="arrow-up text-lg">â–²</span>` : (latestVol < prevVol) ? `<span class="arrow-down text-lg">â–¼</span>` : `<span class="text-gray-500 text-lg">=</span>`;
                comparisonHtml += `
                    <div class="comparison-grid p-2 bg-gray-900 rounded">
                        <p class="exercise-name font-bold col-span-3 text-center text-amber-400 mb-1">${name}</p>
                        <div class="text-center text-sm"><p>${latestEx ? `${latestEx.weight}kg x ${latestEx.reps} x ${latestEx.sets}` : 'ê¸°ë¡ ì—†ìŒ'}</p><p class="font-bold">${latestVol.toLocaleString()}kg</p></div>
                        <div class="text-center">${arrow}</div>
                        <div class="text-center text-sm text-gray-400"><p>${prevEx ? `${prevEx.weight}kg x ${prevEx.reps} x ${prevEx.sets}` : 'ê¸°ë¡ ì—†ìŒ'}</p><p class="font-bold">${prevVol.toLocaleString()}kg</p></div>
                    </div>`;
            });
            ui.comparisonCard.innerHTML = comparisonHtml;
        }

        // ê°œì¸ ìµœê³  ê¸°ë¡(ì´ ë³¼ë¥¨)ì„ UIì— ì—…ë°ì´íŠ¸
        function updatePersonalBest() {
            const personalBest = Math.max(...allSessions.map(s => s.total_volume), 0);
            ui.personalBestVolume.textContent = `${personalBest.toLocaleString()}kg`;
        }
        
        // 'í›ˆë ¨ ë¶„ì„!' ë²„íŠ¼ í´ë¦­ ì‹œ ìµœì‹  ì„¸ì…˜ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ ë° ì¡°ì–¸ ìƒì„±
        async function analyzeRoutine() {
            ui.loading.style.display = 'block';
            ui.feedbackBox.style.display = 'none';
            ui.analyzeBtn.disabled = true;
            
            const sortedSessions = [...allSessions].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const latestSession = sortedSessions[0];
            const previousSession = sortedSessions[1];
            
            let motivationalMessage = "", ragAdvice = "", feedbackColorClass = "";

            if (!latestSession) {
                motivationalMessage = `<p class="text-xl font-bold">ì•„ì§ ì „íˆ¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p><p class="mt-2">ìœ„ëŒ€í•œ ì—¬ì •ì˜ ì²«ê±¸ìŒì„ ë‚´ë”›ìœ¼ì‹­ì‹œì˜¤. ì§€ê¸ˆ ë°”ë¡œ í›ˆë ¨ì„ ê¸°ë¡í•˜ì„¸ìš”!</p>`;
                feedbackColorClass = "bg-gray-800 border-gray-700";
            } else if (!previousSession) {
                 motivationalMessage = `<p class="text-xl font-bold text-green-500">ì²« ë²ˆì§¸ ì „íˆ¬ ê¸°ë¡ì„ ì¶•í•˜í•©ë‹ˆë‹¤!</p><p class="mt-2">ì´ì œ ë‹¹ì‹ ì˜ ë°ì´í„°ê°€ ìŒ“ì´ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í›ˆë ¨ì—ì„œ ì˜¤ëŠ˜ë³´ë‹¤ ê°•í•´ì§„ ìì‹ ì„ ì¦ëª…í•˜ì‹­ì‹œì˜¤.</p>`;
                 feedbackColorClass = "bg-green-950 border-green-800";
            } else {
                const volumeDiff = latestSession.total_volume - previousSession.total_volume;

                if (volumeDiff > 0) {
                    motivationalMessage = `<p class="text-2xl font-black black-han-sans text-green-500">ê³¼ê±°ì˜ ë‚˜ë¥¼ ì™„ë²½íˆ ì´ê²¨ëƒˆêµ°ìš”!</p><p class="mt-2">ì˜¤ëŠ˜ ì •ë§ ë¹¡ì…ŒìŠµë‹ˆë‹¤! ì´ ë³¼ë¥¨ì´ ${volumeDiff.toLocaleString()}kgì´ë‚˜ ëŠ˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì„±ì¥ì— ì•ˆì£¼í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.</p>`;
                    ragAdvice = `<h4 class="font-bold mt-4 pt-4 border-t border-gray-700">AI ì½”ì¹˜ ì¡°ì–¸</h4><p class="text-sm mt-1">ì´ ê¸°ì„¸ ê·¸ëŒ€ë¡œ ë‹¤ìŒ ëª©í‘œë¥¼ í–¥í•´ ì •ì§„í•©ì‹œë‹¤! í›Œë¥­í•œ ì„±ê³¼ì…ë‹ˆë‹¤. ëª¸ì´ ë³´ë‚´ëŠ” íšŒë³µ ì‹ í˜¸ë¥¼ ë¬´ì‹œí•˜ì§€ ë§ê³ , ì¶©ë¶„í•œ ì˜ì–‘ê³¼ íœ´ì‹ì„ ë³´ì¥í•´ì•¼ ì´ ì„±ì¥ì„ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
                    feedbackColorClass = "bg-green-950 border-green-800";
                } else if (volumeDiff < 0) {
                    motivationalMessage = `<p class="text-2xl font-black black-han-sans text-red-500">ì˜¤ëŠ˜ì€ ì–´ì œì˜ ë‚˜ì—ê²Œ ì¡ŒìŠµë‹ˆë‹¤.</p><p class="mt-2">ì´ ë³¼ë¥¨ì´ ${Math.abs(volumeDiff).toLocaleString()}kg ì¤„ì—ˆìŠµë‹ˆë‹¤. ê´œì°®ìŠµë‹ˆë‹¤. íŒ¨ë°°ë¥¼ ì¸ì •í•˜ê³  ë¶„ì„í•´ì•¼ ë” ê°•í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
                    ragAdvice = `<h4 class="font-bold mt-4 pt-4 border-t border-gray-700">AI ì½”ì¹˜ ì¡°ì–¸</h4><p class="text-sm mt-1">ì´ê±´ í›„í‡´ê°€ ì•„ë‹ˆë¼, ë” ë†’ì´ ë›°ê¸° ìœ„í•œ ì¤€ë¹„ì…ë‹ˆë‹¤. ëª¸ì´ ë³´ë‚´ëŠ” í”¼ë¡œ ì‹ í˜¸ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ, ë¬´ë¦¬í•˜ì§€ ë§ê³  ì¶©ë¶„íˆ íœ´ì‹í•˜ë©° ë‹¤ìŒ ì „íˆ¬ë¥¼ ì¤€ë¹„í•˜ì‹­ì‹œì˜¤. ì‰¬ëŠ” ê²ƒë„ í›ˆë ¨ì˜ ì¼ë¶€ì…ë‹ˆë‹¤.</p>`;
                    feedbackColorClass = "bg-red-950 border-red-800";
                } else {
                    motivationalMessage = `<p class="text-2xl font-black black-han-sans text-amber-500">ì œìë¦¬ê±¸ìŒì€ í›„í‡´ë‚˜ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤.</p><p class="mt-2">ëª¸ì´ í˜„ì¬ì˜ ìê·¹ì— ì™„ë²½íˆ ì ì‘í–ˆë‹¤ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤. ì•ˆì£¼í•˜ì§€ ë§ˆì‹­ì‹œì˜¤!</p>`;
                    ragAdvice = `<h4 class="font-bold mt-4 pt-4 border-t border-gray-700">AI ì½”ì¹˜ ì¡°ì–¸</h4><p class="text-sm mt-1">ë‹¤ìŒ í›ˆë ¨ì—ì„œëŠ” ìš´ë™ ìˆœì„œë¥¼ ë°”ê¾¸ê±°ë‚˜, ë“œë¡­ ì„¸íŠ¸ ê°™ì€ ìƒˆë¡œìš´ ë°©ë²•ìœ¼ë¡œ ì´ ë²½ì„ ë¶€ìˆ´ë²„ë¦¬ì‹­ì‹œì˜¤! í•œê³„ë¥¼ ë„˜ì–´ì„œì•¼ ì„±ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
                    feedbackColorClass = "bg-amber-950 border-amber-800";
                }
            }
            
            // 1ì´ˆ í›„ ë¡œë”© ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
            setTimeout(() => {
                ui.loading.style.display = 'none';
                ui.feedbackBox.style.display = 'block';
                ui.feedbackBox.className = `card p-6 min-h-[150px] flex items-center justify-center ${feedbackColorClass}`;
                ui.feedbackMsg.innerHTML = motivationalMessage + (ragAdvice ? ragAdvice : '');
                ui.analyzeBtn.disabled = false;
            }, 1000);
        }
        
        // 'ì‹ë‹¨ ë¶„ì„!' ë²„íŠ¼ í´ë¦­ ì‹œ ì‚¬ìš©ì ì •ë³´ì™€ ìµœì‹  ì‹ë‹¨ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„ ë° ì¡°ì–¸ ìƒì„±
        async function analyzeDiet() {
            ui.dietLoading.style.display = 'block';
            ui.dietFeedbackBox.style.display = 'none';
            ui.analyzeDietBtn.disabled = true;

            const profile = JSON.parse(localStorage.getItem('userProfile'));
            const sortedNutrition = [...allNutrition].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const latestNutrition = sortedNutrition[0];

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!profile || !profile.age || !profile.height || !profile.weight) {
                 setTimeout(() => {
                    ui.dietLoading.style.display = 'none';
                    ui.dietFeedbackBox.style.display = 'block';
                    ui.dietFeedbackMsg.innerHTML = `<p class="text-red-400">ì‚¬ìš©ì ì •ë³´(ë‚˜ì´, í‚¤, ì²´ì¤‘ ë“±)ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì•¼ ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>`;
                    ui.analyzeDietBtn.disabled = false;
                }, 500);
                return;
            }
             if (!latestNutrition) {
                 setTimeout(() => {
                    ui.dietLoading.style.display = 'none';
                    ui.dietFeedbackBox.style.display = 'block';
                    ui.dietFeedbackMsg.innerHTML = `<p class="text-amber-400">ë¶„ì„í•  ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜¤ëŠ˜ì˜ ì˜ì–‘ ì„­ì·¨ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.</p>`;
                    ui.analyzeDietBtn.disabled = false;
                }, 500);
                return;
            }

            // í•´ë¦¬ìŠ¤-ë² ë„¤ë”•íŠ¸ ë°©ì •ì‹ìœ¼ë¡œ ê¸°ì´ˆëŒ€ì‚¬ëŸ‰(BMR) ë° í™œë™ëŒ€ì‚¬ëŸ‰(TDEE) ê³„ì‚°
            const { age, gender, height, weight, activityLevel } = profile;
            let bmr;
            if (gender === 'male') {
                bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
            const tdee = Math.round(bmr * activityLevel);

            // ê¶Œì¥ ì„­ì·¨ëŸ‰ ê³„ì‚°
            const recProtein = Math.round(weight * 1.8);
            const recFat = Math.round((tdee * 0.25) / 9);
            const recCarbs = Math.round((tdee - (recProtein * 4) - (recFat * 9)) / 4);
            const loggedCalories = (latestNutrition.carbs * 4) + (latestNutrition.protein * 4) + (latestNutrition.fat * 9);

            // Gemini APIì— ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸ êµ¬ì„±
            const systemPrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ìš´ë™ì½”ì¹˜ì…ë‹ˆë‹¤. ì œê³µëœ ì‚¬ìš©ì ë°ì´í„°ì™€ ê³„ì‚°ëœ ì˜ì–‘ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ìƒì„¸í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì‹ë‹¨ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ë¦¬í¬íŠ¸ëŠ” ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
1.  **ì´í‰**: í˜„ì¬ ì„­ì·¨ëŸ‰ê³¼ ê¶Œì¥ ì„­ì·¨ëŸ‰ì„ ë¹„êµí•˜ì—¬ ê¸ì •ì ì´ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì „ë°˜ì ì¸ í‰ê°€ë¥¼ ë‚´ë¦½ë‹ˆë‹¤.
2.  **êµ¬ì²´ì ì¸ ì¡°ì–¸**: ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ë‹¤ìŒ ì‹ì‚¬ë‚˜ ë‹¤ìŒ ë‚  ì‹ë‹¨ì—ì„œ ê°œì„ í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ì„ 2-3ê°€ì§€ ì œì•ˆí•©ë‹ˆë‹¤. (ì˜ˆ: "ë‹¨ë°±ì§ˆì´ ë¶€ì¡±í•˜ë‹ˆ ë‹¤ìŒ ì‹ì‚¬ì— ë‹­ê°€ìŠ´ì‚´ 100gì„ ì¶”ê°€í•´ë³´ì„¸ìš”.")
3.  **í˜•ì‹**: ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•˜ì—¬ ì œëª©, ëª©ë¡ ë“±ì„ ë³´ê¸° ì¢‹ê²Œ êµ¬ì„±í•´ì£¼ì„¸ìš”.
4.  **ê°•ì¡° í‘œì‹œ**: ì„­ì·¨ëŸ‰ì´ ê¶Œì¥ëŸ‰ì— ë¹„í•´ 'ë¶€ì¡±'í•œ ê²½ìš°, í•´ë‹¹ ìˆ˜ì¹˜ë‚˜ ì„¤ëª…ì„ \`@@RED@@ë¶€ì¡±í•œ ë¶€ë¶„@@/RED@@\`ìœ¼ë¡œ ê°ì‹¸ì£¼ì„¸ìš”. ì„­ì·¨ëŸ‰ì´ ì ì ˆí•˜ê±°ë‚˜ ì´ˆê³¼í•œ ê²½ìš°ì—ëŠ” ì´ í‘œì‹œë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
<!--**ìƒì„¸ ë¶„ì„**: íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© ì„­ì·¨ëŸ‰ì„ ê°ê° ê¶Œì¥ëŸ‰ê³¼ ë¹„êµí•˜ì—¬ ë¶„ì„í•˜ê³ , ê° ì˜ì–‘ì†Œì˜ ì—­í• ê³¼ ì¤‘ìš”ì„±ì„ ê°„ë‹¨íˆ ì„¤ëª…í•©ë‹ˆë‹¤. -->

            const context = `### ë¶„ì„ ë°ì´í„°
- **ì‚¬ìš©ì í”„ë¡œí•„**: ë‚˜ì´ ${age}ì„¸, ì„±ë³„ ${gender}, í‚¤ ${height}cm, ì²´ì¤‘ ${weight}kg, í™œë™ ìˆ˜ì¤€ ${activityLevel}
- **ê³„ì‚°ëœ ê¶Œì¥ ì„­ì·¨ëŸ‰**:
  - ì´ ì¹¼ë¡œë¦¬(TDEE): ì•½ ${tdee} kcal
  - íƒ„ìˆ˜í™”ë¬¼: ${recCarbs} g
  - ë‹¨ë°±ì§ˆ: ${recProtein} g
  - ì§€ë°©: ${recFat} g
- **ìµœê·¼ ê¸°ë¡ëœ ì„­ì·¨ëŸ‰**:
  - ì´ ì¹¼ë¡œë¦¬: ì•½ ${loggedCalories} kcal
  - íƒ„ìˆ˜í™”ë¬¼: ${latestNutrition.carbs} g
  - ë‹¨ë°±ì§ˆ: ${latestNutrition.protein} g
  - ì§€ë°©: ${latestNutrition.fat} g
  - BCAA: ${latestNutrition.bcaa} g
  - í¬ë ˆì•„í‹´: ${latestNutrition.creatine} g
  - ê¸€ë£¨íƒ€ë¯¼: ${latestNutrition.glutamine} g

ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ë‹¨ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: context }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // ì„œë²„ë¡œ ë³´ë‚¼ ë•ŒëŠ” payload ê°ì²´ë¡œ í•œë²ˆ ê°ì‹¸ì¤ë‹ˆë‹¤.
                    body: JSON.stringify({ payload })
                });

                if (!response.ok) throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);

                const result = await response.json();
                const feedback = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (feedback) {
                    // ë§ˆí¬ë‹¤ìš´ ë° ì»¤ìŠ¤í…€ íƒœê·¸ë¥¼ HTMLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                    const htmlFeedback = feedback
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // ë³¼ë“œì²´ ë³€í™˜
                        .replace(/@@RED@@(.*?)@@\/RED@@/g, '<span class="text-red-400 font-bold">$1</span>') // ë¹¨ê°„ìƒ‰ ê°•ì¡° ë³€í™˜
                        .replace(/(\r\n|\n|\r)/gm, "<br>"); // ì¤„ë°”ê¿ˆ ë³€í™˜
                    ui.dietFeedbackMsg.innerHTML = htmlFeedback;
                } else {
                    throw new Error("AIê°€ ìœ íš¨í•œ ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("ì‹ë‹¨ ë¶„ì„ AI í˜¸ì¶œ ì˜¤ë¥˜:", error);
                ui.dietFeedbackMsg.innerHTML = `<p class="text-red-400">AI ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            } finally {
                ui.dietLoading.style.display = 'none';
                ui.dietFeedbackBox.style.display = 'block';
                ui.analyzeDietBtn.disabled = false;
            }
        }

        // --- ì±—ë´‡ ë¡œì§ ---
        // ì±„íŒ… ë©”ì‹œì§€ë¥¼ UIì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function addChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            messageDiv.textContent = message;
            ui.chatMessages.appendChild(messageDiv);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight; // í•­ìƒ ìµœì‹  ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
        }

        // ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬ í•¨ìˆ˜
        async function handleSendMessage() {
            const userInput = ui.chatInput.value.trim();
            if (!userInput) return;

            addChatMessage(userInput, 'user');
            ui.chatInput.value = '';
            ui.chatSendBtn.disabled = true;

            // 'ìƒê° ì¤‘' ì¸ë””ì¼€ì´í„° í‘œì‹œ
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'chat-message ai-message';
            thinkingDiv.innerHTML = `<span class="pulse inline-block w-2 h-2 bg-gray-400 rounded-full"></span>`;
            ui.chatMessages.appendChild(thinkingDiv);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
            
            try {
                // AI ì‘ë‹µ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ (ì‹œë®¬ë ˆì´ì…˜)
                const aiResponse = await getAiNutritionAdvice(userInput);
                thinkingDiv.remove(); // 'ìƒê° ì¤‘' ì¸ë””ì¼€ì´í„° ì œê±°
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("AI ì‘ë‹µ ì˜¤ë¥˜:", error);
                thinkingDiv.textContent = "ì£„ì†¡í•©ë‹ˆë‹¤, ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            } finally {
                ui.chatSendBtn.disabled = false;
            }
        }
        
        // RAG(ê²€ìƒ‰ ì¦ê°• ìƒì„±)ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ AI ì˜ì–‘ ì¡°ì–¸ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        async function getAiNutritionAdvice(userQuery) {
            // 1. Retrieve Context (ì‚¬ìš©ì ë°ì´í„° ê²€ìƒ‰)
            const profile = JSON.parse(localStorage.getItem('userProfile')) || {};
            const recentNutrition = allNutrition.slice(-3); // Get last 3 entries
            const recentSessions = allSessions.slice(-3);   // Get last 3 entries

            // 2. Construct Prompt (LLMì— ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸ êµ¬ì„±)
            let context = "### ì‚¬ìš©ì ë°ì´í„°\n";
            context += `- í”„ë¡œí•„: ë‚˜ì´ ${profile.age || 'N/A'}, ì„±ë³„ ${profile.gender || 'N/A'}, í‚¤ ${profile.height || 'N/A'}cm, ì²´ì¤‘ ${profile.weight || 'N/A'}kg\n`;
            
            context += "- ìµœê·¼ ì˜ì–‘ ê¸°ë¡ (ìµœëŒ€ 3ê°œ):\n";
            if(recentNutrition.length > 0) {
                recentNutrition.forEach(n => {
                    context += `  - íƒ„ìˆ˜í™”ë¬¼: ${n.carbs}g, ë‹¨ë°±ì§ˆ: ${n.protein}g, ì§€ë°©: ${n.fat}g\n`;
                });
            } else {
                context += "  - ê¸°ë¡ ì—†ìŒ\n";
            }

            context += "- ìµœê·¼ í›ˆë ¨ ê¸°ë¡ (ìµœëŒ€ 3ê°œ):\n";
             if(recentSessions.length > 0) {
                recentSessions.forEach(s => {
                    context += `  - ë‚ ì§œ: ${s.created_at ? new Date(s.created_at).toLocaleDateString() : 'N/A'}, ì´ ë³¼ë¥¨: ${s.total_volume}kg\n`;
                });
            } else {
                context += "  - ê¸°ë¡ ì—†ìŒ\n";
            }
            
            const systemPrompt = `ìŠ¤íŒŒë¥´íƒ€ ì½”ì¹˜ì´ì ì„¸ê³„ì ì¸ ì˜ì–‘ì½”ì¹˜ë‹¤. ë„ˆëŠ” ì‚¬ìš©ìì˜ í›ˆë ¨ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬, ê·¸ë“¤ì˜ ì„±ì¥ì„ ì¹­ì°¬í•˜ê±°ë‚˜, ë‚˜íƒœí•¨ì„ ì§ˆì±…í•œë‹¤. ë„ˆì˜ ëª©í‘œëŠ” ì‚¬ìš©ìê°€ í•œê³„ë¥¼ ë„˜ì–´ì„œë„ë¡ ë™ê¸°ë¥¼ ë¶€ì—¬í•˜ëŠ” ê²ƒì´ë‹¤.
- ë§ˆì§€ë§‰ í›ˆë ¨ ì„¸ì…˜ì˜ ì´ ë³¼ë¥¨ì´ ì´ì „ ì„¸ì…˜ë³´ë‹¤ ë†’ìœ¼ë©´, ê·¸ ì„±ê³¼ë¥¼ ì¸ì •í•˜ë˜, ìë§Œí•˜ì§€ ë§ë¼ê³  ê²½ê³ í•˜ë¼. (ì˜ˆ: "ê³¼ê±°ì˜ ë‚˜ë¥¼ ì´ê²¼êµ°! í•˜ì§€ë§Œ ì´ê±´ ì‹œì‘ì— ë¶ˆê³¼í•˜ë‹¤!")
- ë³¼ë¥¨ì´ ë‚®ì•„ì¡Œë‹¤ë©´, íŒ¨ë°°ë¥¼ ì¸ì •í•˜ê³  ë‹¤ìŒ ì „íˆ¬ë¥¼ ì¤€ë¹„í•˜ë¼ê³  ì—„ê²©í•˜ê²Œ ì¡°ì–¸í•˜ë¼. (ì˜ˆ: "ì˜¤ëŠ˜ì€ ì¡Œì§€ë§Œ, ì´ íŒ¨ë°°ì—ì„œ ë°°ì›Œë¼. ì‰¬ëŠ” ê²ƒë„ í›ˆë ¨ì´ë‹¤.")
- ë³¼ë¥¨ì´ ê°™ë‹¤ë©´, ì •ì²´ëŠ” í›„í‡´ì™€ ê°™ë‹¤ê³  ê²½ê³ í•˜ë©° ìƒˆë¡œìš´ ìê·¹ì„ ì°¾ìœ¼ë¼ê³  ëª…ë ¹í•˜ë¼. (ì˜ˆ: "ì œìë¦¬ê±¸ìŒì€ í›„í‡´ë‹¤! ë‹¤ìŒì—” ë¬´ê²Œë¥¼ ì˜¬ë¦¬ê±°ë‚˜, ì„¸íŠ¸ ìˆ˜ë¥¼ ëŠ˜ë ¤ë¼!")
- í›ˆë ¨ ì„±ê³¼ê°€ ë¶€ì§„í•  ê²½ìš°(ë³¼ë¥¨ ì •ì²´ ë˜ëŠ” ê°ì†Œ), ë‹¨ë°±ì§ˆ ì„­ì·¨ ë¶€ì¡± ë“± í•„ìˆ˜ ì˜ì–‘ ë¬¸ì œì˜ ì›ì¸ì„ ê¼¼ê¼¼íˆ ì°¾ì•„ ì§€ì í•˜ê³  ì˜ì–‘ ê¸°ë¡ì„ ì ê²€í•˜ë¼ê³  ëª…ë ¹í•  ìˆ˜ ìˆë‹¤. ì‚¬ìš©ìê°€ ë¨¹ì€ í•„ìˆ˜ ì˜ì–‘ì†Œê°€ ê¶Œì¥ëŸ‰ ê¸°ì¤€ì— ë¹„í•´ ë‚®ì„ ì‹œ, í•´ë‹¹ ì˜ì–‘ì†Œ ë¶€ë¶„ì— \`[WARNING]\`ê³¼ \`[/WARNING]\` íƒœê·¸ë¥¼ ë°˜ë“œì‹œ ë¶™ì—¬ë¼. (ì˜ˆ: \`[WARNING]ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ì´ ë¶€ì¡±í•˜ë‹¤.[/WARNING]\`)
- ë¶„ì„ì€ í•­ìƒ ì§§ê³  ê°•ë ¥í•œ ì´í‰ìœ¼ë¡œ ì‹œì‘í•˜ê³ , ê·¸ ë’¤ì— êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ 1~2ê°€ì§€ ì œê³µí•˜ë¼. ì œì‹œí•œ ì˜ì–‘ ê´€ë ¨ ì¡°ì–¸ì„ ì‚¬ìš©ìê°€ ê³„ì† ë¬´ì‹œí•˜ëŠ” íŒ¨í„´ì´ ë°ì´í„°ìƒìœ¼ë¡œ ë³´ì¼ ê²½ìš°, "ê²½ê³ : í˜„ì¬ ì˜ì–‘ ìƒíƒœë¡œëŠ” ê·¼ìœ¡ ì„±ì¥ì— ë¶€ì í•©í•˜ë‹¤." ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ë¼.
- ë§íˆ¬ëŠ” ë‹¨í˜¸í•´ì•¼ í•˜ë©°, ë°˜ë“œì‹œ ì£¼ì–´ì§„ ì‚¬ìš©ìì˜ ë°ì´í„°ì—ë§Œ ê·¼ê±°í•˜ì—¬ ë¶„ì„í•˜ê³  ì¡°ì–¸í•´ì•¼ í•œë‹¤. ì£¼ì–´ì§„ ë°ì´í„°ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ë¡œ ì¶”ì¸¡í•˜ê±°ë‚˜ ë°°ê²½ì§€ì‹ì„ í™œìš©í•´ ë§í•˜ì§€ ë§ˆë¼. ğŸ”¥, ğŸ’ª, ğŸ‹ï¸ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ë¼.`;
            const userQueryWithContext = context + "\n### ì‚¬ìš©ìì˜ ì§ˆë¬¸\n" + userQuery;

            const payload = {
                contents: [{ parts: [{ text: userQueryWithContext }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    return "AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                }
            } catch (error) {
                console.error("Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                return "AIì™€ í†µì‹ í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
        async function main() {
            await init(); // ì´ˆê¸°í™”
            // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            ui.addBtn.addEventListener('click', addExerciseInput);
            ui.recordBtn.addEventListener('click', recordSession);
            ui.analyzeBtn.addEventListener('click', analyzeRoutine);
            ui.recordNutritionBtn.addEventListener('click', recordNutrition);
            ui.analyzeDietBtn.addEventListener('click', analyzeDiet);
            
            ui.userProfileForm.addEventListener('change', saveUserProfile);

            ui.exerciseFilter.addEventListener('change', (e) => updateChart(e.target.value));
            
            // ì±—ë´‡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            ui.chatSendBtn.addEventListener('click', handleSendMessage);
            ui.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { handleSendMessage(); }
            });

            addExerciseInput(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ìš´ë™ ì…ë ¥ í¼ 1ê°œ ì¶”ê°€
        }

        // í˜ì´ì§€ ë¡œë“œê°€ ì™„ë£Œë˜ë©´ main í•¨ìˆ˜ ì‹¤í–‰
        window.onload = main;
    </script>
</body>
</html>
